
## 1. 交易被用户使用eth_sendRawTransaction接口发送给执行层客户端，交易会如何被保存？
在Web3.0的以太坊生态中，当用户通过`eth_sendRawTransaction`接口发送一笔签名交易后，交易会经历以下流程被保存和执行：

   1.1 **交易提交到执行层客户端**
   - 用户构造交易并签名，生成**RLP编码的原始交易数据**（RawTransaction）。
   - 通过JSON-RPC调用`eth_sendRawTransaction`将交易发送到连接的执行层客户端（如Geth、Nethermind等）。

   1.2 **交易验证与临时存储（交易池）**
   - **验证阶段**：
     - 客户端验证交易签名、Nonce、Gas等基本合法性。
     - 检查账户余额是否足够支付Gas费用。
     - 拒绝无效交易（返回错误）。
   - **存入交易池（Mempool）**：
     - 有效交易被存入节点的本地**交易池**，这是一个临时存储区。
     - 交易池按Gas Price和Nonce排序，优先处理高Gas交易。

   1.3 **广播到P2P网络**
   - 执行层客户端通过**Devp2p协议**将交易广播给其他节点。
   - 其他节点重复验证流程，并加入各自的交易池，形成去中心化传播。

   1.4 **打包到区块**
   - **验证者/矿工**从交易池选择交易，按优先级打包到新区块。
     - 在PoW中，矿工打包；在PoS（如以太坊2.0）中，验证者负责。
   - 交易被包含在区块的**交易列表**中，成为区块链的一部分。

   1.5 **区块确认与最终存储**
   - 区块通过共识机制（如PoS的LMD-GHOST）被确认。
   - 执行层客户端将区块数据写入本地区块链数据库（如LevelDB/RocksDB），交易被永久保存。
   - 交易状态（成功/失败）由EVM执行结果决定，并更新世界状态。

   关键存储位置
   1. **交易池（内存）**：临时存储未确认交易，重启后消失。
   2. **区块链数据库（磁盘）**：交易最终以区块形式持久化存储。
   3. **状态树（Merkle Patricia Trie）**：交易导致的状态变更存储在状态树中。

   补充说明
   - **去中心化**：交易需要被多数节点验证和存储，确保一致性。
   - **交易生命周期**：若交易长时间未打包，可能因Gas过低被丢弃。
   - **客户端差异**：不同客户端（Geth vs. Erigon）的存储优化方式可能不同（如Erigon的归档模式）。

   通过这一流程，交易从用户提交到最终上链，实现了去中心化、不可篡改的存储。
--- 

## 2. 交易被保存后，如何被选中？
   在区块链中，交易被保存到节点的交易池（Mempool）后，需要经过一个**选择机制**才能被打包到区块中并最终上链。以下是交易被选中的关键流程和影响因素：

   2.1 **交易池（Mempool）中的竞争**
   - 所有未确认交易首先存储在节点的交易池中，不同节点的交易池可能略有差异（因网络传播延迟）。
   - 交易池通常按**Gas Price**（或**Priority Fee**）和**Nonce**排序，高Gas交易优先被选中。

   2.2 **交易选择的核心机制**
      **(1) Gas Price 竞拍（PoW/PoS通用）**
     - **Gas Price**：用户支付的交易手续费（单位：Gwei），直接影响优先级。
     - **优先选择逻辑**：
       - 验证者/矿工倾向于选择**Gas Price最高**的交易，以最大化收益。
       - 在以太坊的PoS中，验证者还会考虑**小费（Tip）**，即用户给验证者的额外激励（`maxPriorityFeePerGas`）。

      **(2) Nonce 顺序**
     - 每个账户的交易必须按**Nonce**顺序处理（防止双花）。
     - 即使某笔交易Gas Price高，如果前序Nonce的交易未处理，它也会被暂缓。

      **(3) 区块Gas Limit**
     - 每个区块有**Gas上限**（当前以太坊约3000万Gas），验证者会尽可能填满区块。
     - 低Gas交易可能因区块空间不足被延迟。

   2.3 **验证者/矿工的决策（PoS vs PoW）**
      **以太坊PoS（共识层+执行层）**
     - **验证者角色**：
       1. 当前时段的**区块提议者**（随机选出）从交易池选择交易。
       2. 使用算法（如贪心算法）优化Gas收益，优先打包高优先级交易。
     - **MEV（矿工可提取价值）**：
       - 验证者可能通过MEV策略（如套利、抢跑）重新排序交易以获利（通过Flashbots等服务）。

      **传统PoW（如比特币）**
     - 矿工直接按Gas Price排序，无MEV复杂性问题（但仍有交易替换攻击）。

   2.4 **交易最终确认**
   - 被选中的交易打包到区块后，需经过共识验证：
     - **PoW**：其他矿工验证区块并竞争挖矿。
     - **PoS**：其他验证者对区块投票 attest。
   - 区块获得足够确认后（以太坊PoS为32个epoch），交易变为不可逆。

   2.5. **特殊情况处理**
   - **交易滞留**：如果Gas Price过低，交易可能长期留在交易池，最终被丢弃（可手动替换或加速）。
   - **动态调整**：用户可通过`eth_replaceTransaction`替换未确认交易（提高Gas Price或Nonce）。

   **关键影响因素总结**
| 因素 | 说明 |
|------|------|
| **Gas Price** | 越高越优先，尤其是`maxPriorityFeePerGas`。 |
| **Nonce顺序** | 必须连续，否则后续交易卡住。 |
| **区块Gas Limit** | 限制单区块能包含的交易数量。 |
| **MEV策略** | 验证者可能优化交易顺序获利。 |
| **网络拥堵** | 高流量时只有高Gas交易能被选中。 |

   **用户如何提高交易被选中的概率？**
     1. **设置合理Gas费**：参考当前网络Gas价格（如Etherscan的Gas Tracker），适当提高小费。
     2. **监控Nonce**：确保前序交易已确认。
     3. **使用加速服务**：部分钱包支持替换未确认交易（提高Gas Price）。

通过这一机制，区块链在去中心化环境下实现了交易的公平（价高者优先）和高效处理。
---

## 3. 一个交易消耗的gas如何计算？是什么时候从sender账户扣除？

---

## 4. 创建合约交易和普通交易处理方式的区别？

---

## 5. 创建合约有什么限制？

---

## 6. 交易是怎么被广播给其他执行层客户端的？

---

## 7. PoW(Proof of Work)与PoS(Proof of Stake)?

---

## 8. PoW时期，矿工如何赚取收益？收益什么时候被添加到账户？

---

## 9. PoW时期，如何产生一个新块？并把区块广播出去？

---

## 10. 合并到PoS后，新区块如何同步？